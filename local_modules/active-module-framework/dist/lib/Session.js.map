{"version":3,"file":"Session.js","sourceRoot":"","sources":["../../src/lib/Session.ts"],"names":[],"mappings":"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","sourcesContent":["import { LocalDB } from \"./LocalDB\"\r\nimport { Module } from \"./Module\"\r\n\r\nexport interface AdapterResult {\r\n\tvalue: { [keys: string]: any } | null\r\n\terror: string | null\r\n}\r\nexport interface AdapterResultFormat {\r\n\tglobalHash: string|null\t//ブラウザ共通セッションキー\r\n\tsessionHash: string|null //タブ用セッションキー\r\n\tresults: AdapterResult[]\r\n}\r\n\r\n/**\r\n *セッションデータ管理用クラス\r\n *\r\n * @export\r\n * @class Session\r\n */\r\nexport class Session {\r\n\tstatic requests: ((session: Session) => {})[] = []\r\n\tsessionHash: string|null = null\r\n\tglobalHash: string|null = null\r\n\tresult: AdapterResultFormat|null = null\r\n\tvalues: { [key: string]: any } = {}\r\n\tlocalDB: LocalDB|null = null\r\n\tmoduleTypes: { [key: string]: typeof Module } = {}\r\n\tmodules: Module[] = []\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {LocalDB} db\r\n\t * @param {string} globalHash\r\n\t * @param {string} sessionHash\r\n\t * @param {{ [key: string]: typeof Module }} moduleTypes\r\n\t * @memberof Session\r\n\t */\r\n\tasync init(db: LocalDB, globalHash: string, sessionHash: string, moduleTypes: { [key: string]: typeof Module }) {\r\n\t\tthis.localDB = db\r\n\t\tthis.moduleTypes = moduleTypes\r\n\t\tconst global = await db.startSession(globalHash, 96)\r\n\t\tconst session = await db.startSession(sessionHash, 1)\r\n\t\tthis.globalHash = global.hash\r\n\t\tthis.sessionHash = session.hash\r\n\t\tthis.setValue(\"GLOBAL_ITEM\", global.values)\r\n\t\tthis.setValue(\"SESSION_ITEM\", session.values)\r\n\t\tawait this.request()\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @memberof Session\r\n\t */\r\n\tasync final() {\r\n\t\tif (this.localDB){\r\n\t\t\tif (this.sessionHash)\r\n\t\t\t\tawait this.localDB.endSession(this.sessionHash, this.getValue(\"SESSION_ITEM\"))\r\n\t\t\tif (this.globalHash)\r\n\t\t\t\tawait this.localDB.endSession(this.globalHash, this.getValue(\"GLOBAL_ITEM\"))\r\n\t\t}\r\n\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @static\r\n\t * @param {(session: Session) => {}} func\r\n\t * @memberof Session\r\n\t */\r\n\tpublic static addRequest(func: (session: Session) => {}) {\r\n\t\tSession.requests.push(func);\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @returns {string}\r\n\t * @memberof Session\r\n\t */\r\n\tpublic getSessionHash(): string|null {\r\n\t\treturn this.sessionHash\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} hash\r\n\t * @memberof Session\r\n\t */\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} hash\r\n\t * @memberof Session\r\n\t */\r\n\tpublic setSessionHash(hash: string) {\r\n\t\tthis.sessionHash = hash\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @returns {string}\r\n\t * @memberof Session\r\n\t */\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @returns {string}\r\n\t * @memberof Session\r\n\t */\r\n\tpublic getGlobalHash(): string|null {\r\n\t\treturn this.globalHash\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} hash\r\n\t * @memberof Session\r\n\t */\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} hash\r\n\t * @memberof Session\r\n\t */\r\n\tpublic setGlobalHash(hash: string) {\r\n\t\tthis.globalHash = hash\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} value\r\n\t * @returns\r\n\t * @memberof Session\r\n\t */\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} value\r\n\t * @returns\r\n\t * @memberof Session\r\n\t */\r\n\tpublic setResult(value: AdapterResultFormat) {\r\n\t\treturn this.result = value\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} name\r\n\t * @param {*} value\r\n\t * @memberof Session\r\n\t */\r\n\tpublic setValue(name: string, value:any) {\r\n\t\tthis.values[name] = value\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} name\r\n\t * @returns\r\n\t * @memberof Session\r\n\t */\r\n\tpublic getValue(name: string) {\r\n\t\treturn this.values[name]\r\n\t}\r\n\t/**\r\n\t *\r\n\t *\r\n\t * @param {string} name\r\n\t * @param {*} value\r\n\t * @memberof Session\r\n\t */\r\n\tsetGlobalItem(name: string, value:any) {\r\n\t\tvar items = this.getValue(\"GLOBAL_ITEM\") as {[key: string]: any}\r\n\t\tif (!items) {\r\n\t\t\titems = {}\r\n\t\t\tthis.setValue(\"GLOBAL_ITEM\", items)\r\n\t\t}\r\n\t\titems[name] = value\r\n\t}\r\n\tgetGlobalItem(name: string, defValue?:any) {\r\n\t\tvar items = this.getValue(\"GLOBAL_ITEM\") as { [key: string]: any }\r\n\t\tif (!items) {\r\n\t\t\treturn null\r\n\t\t}\r\n\t\treturn (typeof items[name] === 'undefined') ? defValue : items[name]\r\n\t}\r\n\tsetSessionItem(name: string, value:any) {\r\n\t\tvar items = this.getValue(\"SESSION_ITEM\") as { [key: string]: any }\r\n\t\tif (!items) {\r\n\t\t\titems = {}\r\n\t\t\tthis.setValue(\"SESSION_ITEM\", items)\r\n\t\t}\r\n\t\titems[name] = value\r\n\t}\r\n\tgetSessionItem(name: string, defValue?:any) {\r\n\t\tvar items = this.getValue(\"SESSION_ITEM\") as { [key: string]: any }\r\n\t\tif (!items) {\r\n\t\t\treturn null\r\n\t\t}\r\n\t\treturn (typeof items[name] === 'undefined') ? defValue : items[name]\r\n\t}\r\n\tgetModuleType<T extends typeof Module>(name:string): T {\r\n\t\treturn this.moduleTypes[name] as T\r\n\t}\r\n\tasync getModule<T extends Module>(constructor: { new(): T }): Promise<T|null> {\r\n\t\tfor (let module of this.modules) {\r\n\t\t\tif (module instanceof constructor) {\r\n\t\t\t\treturn module\r\n\t\t\t}\r\n\t\t}\r\n\t\ttry{\r\n\t\t\tconst module = new constructor()\r\n\t\t\tthis.modules.push(module)\r\n\t\t\tmodule.setSession(this)\r\n\t\t\tawait module.onStartSession()\r\n\t\t\treturn module\r\n\t\t}catch(e){\r\n\t\t\tconsole.error(e)\r\n\t\t\tconsole.error(\"モジュールインスタンスの生成に失敗:\"+constructor.name)\r\n\t\t\treturn null\r\n\t\t}\r\n\t}\r\n\tasync releaseModules() {\r\n\t\tfor (let module of this.modules) {\r\n\t\t\tawait module.onEndSession()\r\n\t\t}\r\n\t}\r\n\tasync request() {\r\n\t\tvar p = [];\r\n\t\tfor (var i = 0; i < Session.requests.length; i++)\r\n\t\t\tp.push(Session.requests[i](this));\r\n\t\tawait Promise.all(p);\r\n\t}\r\n}"]}